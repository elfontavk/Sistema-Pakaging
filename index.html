<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluador Packaging + IA</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #05060f;
            color: #e5f2ff;
            min-height: 100vh;
        }
        html { scroll-behavior: smooth; }
        .header {
            background: #0d1220;
            padding: 16px 12px;
            border-bottom: 2px solid #00ff41;
            text-align: center;
        }
        .header h1 { font-size: 1.2rem; color: #00ff41; }
        .header p { font-size: 0.85rem; color: #58ffc7; margin-top: 4px; }
        .container { padding: 14px; max-width: 1200px; margin: 0 auto; }
        .section {
            background: #0d1220;
            border: 1px solid #131a2e;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .section-title {
            color: #00ff41;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 220px;
            overflow-y: auto;
            padding-right: 4px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            background: #131a2e;
            border-radius: 4px;
        }
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #00ff41;
        }
        .checkbox-item label { flex: 1; font-size: 0.9rem; }
        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            margin: 16px 0;
        }
        .btn {
            padding: 14px;
            border-radius: 8px;
            border: 2px solid #00ff41;
            background: #131a2e;
            color: #e5f2ff;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s all;
        }
        .btn:hover { background: #00ff41; color: #05060f; }
        .btn-ia { border-color: #58ffc7; }
        .btn-reset { border-color: #ffcc70; }
        .results {
            background: #0d1220;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 14px;
            max-height: 520px;
            overflow-y: auto;
        }
        .results h3 { color: #00ff41; margin-bottom: 6px; }
        .alert {
            padding: 8px 10px;
            margin: 6px 0;
            border-radius: 4px;
            border-left: 4px solid;
            font-size: 0.9rem;
            white-space: pre-line;
        }
        .alert-error { background: rgba(255,107,107,0.1); border-color: #ff6b6b; color: #ff8686; }
        .alert-warning { background: rgba(255,204,112,0.1); border-color: #ffcc70; color: #ffd083; }
        .alert-info { background: rgba(88,255,199,0.1); border-color: #58ffc7; color: #a3ffe3; }
        .sequence {
            margin-top: 8px;
            padding: 10px;
            background: #131a2e;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .sequence-item { padding: 3px 0; }
        @media (max-width: 768px) {
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Packaging + Lux Assistant (Web)</h1>
        <p>Solo Evaluaci√≥n ‚Äì Botones: Evaluar | Evaluar con IA | Reset</p>
    </header>

    <main class="container">
        <div class="section">
            <div class="section-title">Material(es)</div>
            <div class="checkbox-group" id="materials-eval"></div>
        </div>
        <div class="section">
            <div class="section-title">Tinta(s)</div>
            <div class="checkbox-group" id="inks-eval"></div>
        </div>
        <div class="section">
            <div class="section-title">Barniz(es) / Laca(s)</div>
            <div class="checkbox-group" id="varnishes-eval"></div>
        </div>
        <div class="section">
            <div class="section-title">Laminado(s) / Film(s)</div>
            <div class="checkbox-group" id="films-eval"></div>
        </div>
        <div class="section">
            <div class="section-title">Acabados</div>
            <div class="checkbox-group" id="finishes-eval"></div>
        </div>
        <div class="section">
            <div class="section-title">Pegado / Adhesivo</div>
            <div class="checkbox-group" id="adhesion-eval"></div>
        </div>
        <div class="section">
            <div class="section-title">Proceso / Contexto</div>
            <div class="checkbox-group" id="process-flags-eval"></div>
        </div>

        <div class="actions">
            <button class="btn" onclick="evaluarCompatibilidad()">üß™ Evaluar compatibilidad</button>
            <button class="btn btn-ia" onclick="evaluarConIA()">ü§ñ Evaluar con IA</button>
            <button class="btn btn-reset" onclick="resetearFormulario()">üîÑ Refrescar / Reset</button>
        </div>

        <section class="results" id="results-eval">
            <h3>Resultados de evaluaci√≥n</h3>
            <p style="color:#58ffc7;">Selecciona componentes y pulsa ‚ÄúEvaluar compatibilidad‚Äù.</p>
        </section>

        <section class="results" id="results-ia">
            <h3>ü§ñ An√°lisis IA</h3>
            <p style="color:#58ffc7;">Pulsa ‚ÄúEvaluar con IA‚Äù para generar el diagn√≥stico inteligente.</p>
        </section>
    </main>

    <script>
        const CONFIG = {
  "catalog": {
    "materials": [
      "ACCURATE",
      "AEGLE PLUS HB FSC MIX CREDIT",
      "ALASKA PLUS",
      "ALGRO DESIGN DUO FSC MIX CREDIT",
      "APET CRISTAL 250mic 70x100 (50% reciclado)",
      "ARCO DESIGN",
      "ARCOPRINT",
      "ARCOPRINT FSC MIX CREDIT",
      "ARENA EXTRA WHITE SMOOTH FSC MIX CREDIT",
      "ASTROPACK BIANCO FSC MIX CREDIT",
      "ASTROPACK BLU&GREEN FSC MIX CREDIT",
      "ASTROPACK FSC MIX CREDIT",
      "ASTROPREMIUM FSC MIX CREDIT",
      "ASTROPRINT BAG  WHITE 179 1E FSC MIX CREDIT",
      "ASTROPRINT CANVAS BIANCO FSC",
      "ASTROPRINT HONEYCOMB FSC",
      "ASTROPRINT NEW BAG 179",
      "BROSSULIN XT BIANCO FSC",
      "CARTULINA LIBRA DOS CARAS FSC MIX CREDIT",
      "CHEVERNY LUXE",
      "CONSTELLATION JADE E21 FSC",
      "CONSTELLATION SILVER PEARL ICE WHITE",
      "CONSTELLATION SNOW FIANDRA E34 FSC MIX CREDIT",
      "CREATOR STAR FSC MIX CREDIT",
      "CRESCENDO 1 CARA",
      "CRESCENDO 1 CARA PEFC 70%",
      "CRESCENDO 2 CARAS",
      "ENSOCOAT 1 CARA FSC MIX CREDIT",
      "FBB BOROFOLDING FSC MIX CREDIT",
      "FIBREFORM BOARD UNCOATED",
      "FOLDING KRAFT",
      "INCADA SILK FSC MIX CREDIT",
      "INVERCOTE 2C FSC MIX CREDIT",
      "INVERCOTE TOUCH FSC MIX CREDIT",
      "MB Prime FBB Bright New FSC MIX CREDIT",
      "MB Prime FBB Bright New PEFC 70%",
      "MB Pro FBB Bright New FSC MIX CREDIT",
      "NANOMICRO E220/KBI80/KBI80",
      "PANKABRITE",
      "RECICLADO REVERSO BLANCO",
      "RECICLADO REVERSO GRIS",
      "ROCHCOAT FSC MIX CREDIT",
      "SIRIO AL CAMP.LOEWE FSC MIX CREDIT",
      "SIRIO GRIGIO AL CAMP. LOEWE",
      "SIRIO GRIGIO AL CAMP. LOEWE FSC",
      "SIRIO PEARL ICE WHITE",
      "SIRIO PEARL ICE WHITE FSC",
      "SIRIO ROUGH DARK BLUE FSC",
      "SIRIO WHITE WHITE",
      "SPLENDORLUX",
      "SPLENDORLUX FSC MIX CREDIT",
      "SYMBOL CARD 2C FSC",
      "SYMBOL FREELIFE SATIN FSC MIX CREDIT",
      "TOM&OTTO GLOS FSC MIX CREDIT",
      "ULTRABOX PLUS FSC MIX CREDIT",
      "PAPEL LAMINADO POLIESTER PLATA"
    ],
    "inks": [
      "Offset Convencional (est√°ndar)",
      "UV Offset",
      "UV-LED Offset / Low Energy UV",
      "Metalicas (plata, oro)"
    ],
    "varnishes": [
      "Barniz brillo flexo 140 no estampable",
      "Barniz brillo flexo 8888 no estampable",
      "Barniz brillo flexo 151 estampable",
      "Barniz brillo flexo 175 estampable bajo amarillamiento",
      "Barniz brillo flexo vk60 estampable, rechazo",
      "soft touch base agua",
      "soft touch base uvi",
      "satinado offset",
      "mate 7946 effect no estampable offset",
      "mate 946 estampable offset",
      "mate S110 estampable",
      "mate 886 no estampable",
      "aquoso laca brillo"
    ],
    "films": [
      "Laminado BOPP brillo",
      "Laminado BOPP mate",
      "Laminado PET brillo",
      "Laminado Soft-touch (velvet)",
      "Laminado Hologr√°fico"
    ],
    "finishes": [
      "Hot foil (estamping caliente)",
      "Cold foil (en fr√≠o)",
      "Cast & Cure (holograf√≠a clara)",
      "Emboss (relieve)",
      "Deboss (bajo relieve)",
      "Relieve multinivel",
      "Serigraf√≠a UV alto dep√≥sito (relieve)",
      "Glitter (serigraf√≠a/UV)",
      "Braille (farma)",
      "Troquel l√°ser / microperforado",
      "Marcado l√°ser (trazabilidad)",
      "C√≥digos invisibles UV/IR"
    ],
    "adhesion_glue": [
      "Pegado PVA (cola blanca)",
      "Hotmelt EVA/PO",
      "Cianoacrilato / especial"
    ],
    "process_flags": [
      "Hendido/plegado",
      "Plegado/encolado",
      "Alimentaci√≥n",
      "Reciclabilidad",
      "Farma"
    ]
  },
  "rules": [
    {
      "when_all": {
        "materials": [
          "MB Prime FBB Bright New FSC MIX CREDIT"
        ],
        "inks": [
          "UV Offset"
        ],
        "varnishes": [
          "mate 7946 effect no estampable offset"
        ],
        "films": [
          "Laminado BOPP brillo"
        ],
        "finishes": [
          "Emboss (relieve)"
        ],
        "adhesion_glue": [
          "Pegado PVA (cola blanca)"
        ]
      },
      "severity": "WARNING",
      "message": "poco relieve: dos pases para mas presion  dependiendo de tama√±o"
    },
    {
      "when_all": {
        "materials": [
          "PAPEL LAMINADO POLIESTER PLATA"
        ],
        "films": [
          "Laminado BOPP brillo"
        ],
        "finishes": [
          "Relieve multinivel"
        ]
      },
      "severity": "WARNING",
      "message": "PRESION RELIEVE: UN PASE POR CADA ESCTUCHE"
    }
  ]
};
        const USER_RULES = [];
        const USER_MATERIALS = [
  {
    "grupo": "",
    "nombre": "ACCURATE",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "AEGLE PLUS HB FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ALASKA PLUS",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ALGRO DESIGN DUO FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "APET CRISTAL 250mic 70x100 (50% reciclado)",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ARCO DESIGN",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ARCOPRINT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ARCOPRINT FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ARENA EXTRA WHITE SMOOTH FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ASTROPACK BIANCO FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ASTROPACK BLU&GREEN FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ASTROPACK FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ASTROPREMIUM FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ASTROPRINT BAG  WHITE 179 1E FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ASTROPRINT CANVAS BIANCO FSC",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ASTROPRINT HONEYCOMB FSC",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ASTROPRINT NEW BAG 179",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "BROSSULIN XT BIANCO FSC",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "CARTULINA LIBRA DOS CARAS FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "CHEVERNY LUXE",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "CONSTELLATION JADE E21 FSC",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "CONSTELLATION SILVER PEARL ICE WHITE",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "CONSTELLATION SNOW FIANDRA E34 FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "CREATOR STAR FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "CRESCENDO 1 CARA",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "CRESCENDO 1 CARA PEFC 70%",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "CRESCENDO 2 CARAS",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ENSOCOAT 1 CARA FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "FBB BOROFOLDING FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "FIBREFORM BOARD UNCOATED",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "FOLDING KRAFT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "INCADA SILK FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "INVERCOTE 2C FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "INVERCOTE TOUCH FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "MB Prime FBB Bright New FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "MB Prime FBB Bright New PEFC 70%",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "MB Pro FBB Bright New FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "NANOMICRO E220/KBI80/KBI80",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "PANKABRITE",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "RECICLADO REVERSO BLANCO",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "RECICLADO REVERSO GRIS",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ROCHCOAT FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "SIRIO AL CAMP.LOEWE FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "SIRIO GRIGIO AL CAMP. LOEWE",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "SIRIO GRIGIO AL CAMP. LOEWE FSC",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "SIRIO PEARL ICE WHITE",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "SIRIO PEARL ICE WHITE FSC",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "SIRIO ROUGH DARK BLUE FSC",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "SIRIO WHITE WHITE",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "SPLENDORLUX",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "SPLENDORLUX FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "SYMBOL CARD 2C FSC",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "SYMBOL FREELIFE SATIN FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "TOM&OTTO GLOS FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "ULTRABOX PLUS FSC MIX CREDIT",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  },
  {
    "grupo": "",
    "nombre": "PAPEL LAMINADO POLIESTER PLATA",
    "alias": "",
    "calibre_mm": "",
    "gramaje_gm2": "",
    "caracter": "",
    "uso": "",
    "observaciones": ""
  }
];

        function crearCheckboxes(id, items) {
            const cont = document.getElementById(id);
            cont.innerHTML = '';
            (items || []).forEach(nombre => {
                const wrapper = document.createElement('div');
                wrapper.className = 'checkbox-item';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.value = nombre;

                const label = document.createElement('label');
                label.textContent = nombre;

                wrapper.appendChild(input);
                wrapper.appendChild(label);
                cont.appendChild(wrapper);
            });
        }

        function inicializar() {
            const catalog = CONFIG.catalog || {};
            if (USER_MATERIALS && Array.isArray(USER_MATERIALS)) {
                catalog.materials = catalog.materials || [];
                USER_MATERIALS.forEach(m => {
                    if (m.nombre && !catalog.materials.includes(m.nombre)) {
                        catalog.materials.push(m.nombre);
                    }
                });
            }

            crearCheckboxes('materials-eval', catalog.materials || []);
            crearCheckboxes('inks-eval', catalog.inks || []);
            crearCheckboxes('varnishes-eval', catalog.varnishes || []);
            crearCheckboxes('films-eval', catalog.films || []);
            crearCheckboxes('finishes-eval', catalog.finishes || []);
            crearCheckboxes('adhesion-eval', catalog.adhesion_glue || []);
            crearCheckboxes('process-flags-eval', catalog.process_flags || []);
        }

        window.onload = inicializar;

        function obtenerSeleccionEval() {
            const seleccion = {};
            const keys = ['materials', 'inks', 'varnishes', 'films', 'finishes', 'adhesion_glue'];
            keys.forEach(key => {
                seleccion[key] = [];
                document.querySelectorAll(`#${key}-eval input[type="checkbox"]:checked`).forEach(cb => {
                    seleccion[key].push(cb.value);
                });
            });

            seleccion.process = [];
            seleccion.context = [];
            document.querySelectorAll('#process-flags-eval input[type="checkbox"]:checked').forEach(cb => {
                const v = cb.value;
                if (v === 'Hendido/Plegado' || v === 'Plegado/encolado' || v === 'Hendido/plegado') {
                    seleccion.process.push(v);
                } else {
                    seleccion.context.push(v);
                }
            });

            return seleccion;
        }

        function ejecutarEvaluacion(seleccion) {
            const hits = [];
            (CONFIG.rules || []).forEach(regla => {
                let cumple = true;
                const condiciones = regla.when_all || {};
                for (const [key, valores] of Object.entries(condiciones)) {
                    const k = key === 'material' ? 'materials' : key;
                    if (k === 'context') {
                        if (!valores.every(v => seleccion.context.includes(v))) {
                            cumple = false;
                            break;
                        }
                    } else {
                        if (!seleccion[k] || !valores.every(v => seleccion[k].includes(v))) {
                            cumple = false;
                            break;
                        }
                    }
                }
                if (cumple) {
                    hits.push({ severity: regla.severity, message: regla.message });
                }
            });

            const subs = seleccion.materials || [];
            const inks = seleccion.inks || [];
            const fins = seleccion.finishes || [];

            (USER_RULES || []).forEach(kr => {
                let triggers = true;
                if (kr.kw_materials?.length) {
                    triggers = triggers && kr.kw_materials.some(kw =>
                        subs.some(s => s.toLowerCase().includes(kw.toLowerCase()))
                    );
                }
                if (kr.kw_inks?.length) {
                    triggers = triggers && kr.kw_inks.some(kw =>
                        inks.some(i => i.toLowerCase().includes(kw.toLowerCase()))
                    );
                }
                if (kr.kw_finishes?.length) {
                    triggers = triggers && kr.kw_finishes.some(kw =>
                        fins.some(f => f.toLowerCase().includes(kw.toLowerCase()))
                    );
                }
                if (triggers) {
                    let msg = `[${kr.severity}] ${kr.name || 'Regla'}: ${kr.message}`;
                    if (kr.remedy) msg += `\n‚Üí ${kr.remedy}`;
                    hits.push({ severity: kr.severity, message: msg });
                }
            });

            const secuencia = generarSecuencia(seleccion);
            const procAlerts = analizarSecuencia(secuencia, subs, inks, fins);
            return { hits, secuencia, procAlerts };
        }

        function evaluarCompatibilidad() {
            const seleccion = obtenerSeleccionEval();
            const resultado = ejecutarEvaluacion(seleccion);
            mostrarResultadosCompatibilidad(seleccion, resultado);
            enfocarResultados('results-eval');
        }

        function evaluarConIA() {
            const seleccion = obtenerSeleccionEval();
            const resultado = ejecutarEvaluacion(seleccion);
            const analisis = generarAnalisisIA(resultado);
            mostrarResultadosIA(analisis);
            enfocarResultados('results-ia');
        }

        function generarSecuencia(seleccion) {
            const seq = [];
            const materials = seleccion.materials || [];
            const inks = seleccion.inks || [];
            const finishes = seleccion.finishes || [];
            const filmsSel = seleccion.films || [];
            const varnishes = seleccion.varnishes || [];

            seq.push("Preimpresi√≥n: perfiles, trapping, reservas (foil/UV/cola).");
            if (materials.some(m => m.toLowerCase().includes("metalizado"))) {
                seq.push("Serigraf√≠a: cama blanca opaca para metalizado si requiere.");
            }
            if (inks.some(i => i.includes("Offset"))) {
                seq.push("Impresi√≥n offset (CMYK/Pantone).");
            }
            if (finishes.some(f => f.includes("Cold foil"))) {
                seq.push("Cold foil en l√≠nea/sobreimprimible (si aplica).");
            }
            if (finishes.some(f => f.toLowerCase().includes("hot foil") || f.toLowerCase().includes("estamping"))) {
                seq.push("Hot foil (tras impresi√≥n; antes de relieve).");
            }
            if (filmsSel.length > 0) {
                seq.push("Laminaci√≥n (brillo/mate/soft-touch) seg√∫n dise√±o.");
            }
            if (varnishes.length > 0) {
                seq.push("Barnices (UV/AQ/anti-scuff) con reservas de cola.");
            }
            if (finishes.some(f => f.toLowerCase().includes("braille"))) {
                seq.push("Braille despu√©s de laminaci√≥n para mantener altura.");
            }
            seq.push("Troquelado + Hendidos.");
            seq.push("Plegado + Pegado.");
            seq.push("Control de calidad final.");
            return seq;
        }

        function analizarSecuencia(sequence, materials, inks, finishes) {
            const alerts = [];
            const seqLower = sequence.map(s => s.toLowerCase());

            if (seqLower.some(s => s.includes("hot foil")) && seqLower.some(s => s.includes("barniz"))) {
                alerts.push({
                    severity: "WARNING",
                    message: "Barniz posterior puede apagar el brillo del foil. Usar OPV para foil o reserva."
                });
            }
            if (finishes.some(f => f.toLowerCase().includes("soft touch")) &&
                finishes.some(f => f.toLowerCase().includes("hot foil"))) {
                alerts.push({
                    severity: "WARNING",
                    message: "Soft-touch con hot foil: baja energ√≠a superficial, usar primer o foil espec√≠fico."
                });
            }
            if (materials.some(m => m.toLowerCase().includes("cast coated")) &&
                finishes.some(f => f.toLowerCase().includes("relieve"))) {
                alerts.push({
                    severity: "WARNING",
                    message: "Cast Coated en relieve profundo: riesgo de craquelado, reducir profundidad y usar utillaje templado."
                });
            }

            return alerts;
        }

        function mostrarResultadosCompatibilidad(seleccion, resultado) {
            const container = document.getElementById('results-eval');
            let html = '<h3>Resultados de evaluaci√≥n</h3>';

            html += '<div style="margin:6px 0;padding:8px;background:#131a2e;border-radius:4px;"><strong>Selecci√≥n actual:</strong><br>';
            for (const [k, vals] of Object.entries(seleccion)) {
                if (vals?.length) {
                    html += `<strong>${k}:</strong> ${vals.join(', ')}<br>`;
                }
            }
            html += '</div>';

            const allHits = [...resultado.hits, ...resultado.procAlerts];
            if (allHits.length) {
                html += '<h4 style="color:#00ff41;margin:8px 0 4px;">Alertas detectadas:</h4>';
                const order = { ERROR: 0, WARNING: 1, INFO: 2 };
                allHits.sort((a, b) => (order[a.severity] ?? 3) - (order[b.severity] ?? 3));
                allHits.forEach(hit => {
                    const cls = hit.severity === 'ERROR' ? 'alert-error'
                              : hit.severity === 'WARNING' ? 'alert-warning'
                              : 'alert-info';
                    html += `<div class="alert ${cls}">${hit.message}</div>`;
                });
            } else {
                html += '<div class="alert alert-info">‚úì Sin alertas con las reglas actuales.</div>';
            }

            html += '<h4 style="color:#00ff41;margin:8px 0 4px;">Secuencia recomendada:</h4>';
            html += '<div class="sequence">';
            resultado.secuencia.forEach((paso, idx) => {
                html += `<div class="sequence-item">${idx + 1}. ${paso}</div>`;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        function generarAnalisisIA(resultado) {
            const totalHits = [...resultado.hits, ...resultado.procAlerts];
            const errores = totalHits.filter(h => h.severity === 'ERROR').length;
            const warnings = totalHits.filter(h => h.severity === 'WARNING').length;
            const esCompatible = errores === 0;
            let nivel = 'BAJO';
            if (errores > 0) nivel = 'CR√çTICO';
            else if (warnings > 0) nivel = 'ALTO';

            const confianza = Math.max(0, Math.min(1, 1 - errores * 0.3 - warnings * 0.1));
            const sugerencias = [];
            if (warnings > 0) sugerencias.push("‚ö†Ô∏è Revisa las advertencias antes de liberar producci√≥n.");
            if (!esCompatible) sugerencias.push("‚ùå Ajusta componentes antes de continuar.");
            if (totalHits.length === 0) sugerencias.push("‚úÖ Sin conflictos detectados, procede con confianza.");

            return {
                esCompatible,
                nivel,
                confianza,
                totalHits: totalHits.length,
                sugerencias
            };
        }

        function mostrarResultadosIA(analisis) {
            const container = document.getElementById('results-ia');
            let html = '<h3>ü§ñ An√°lisis IA</h3>';

            html += `<div class="alert ${analisis.esCompatible ? 'alert-info' : 'alert-error'}" style="border-left-width:5px;">`;
            html += `<strong>Estado:</strong> ${analisis.esCompatible ? '‚úÖ COMPATIBLE' : '‚ùå INCOMPATIBLE'}<br>`;
            html += `<strong>Riesgo:</strong> ${analisis.nivel}<br>`;
            html += `<strong>Confianza:</strong> ${(analisis.confianza * 100).toFixed(0)}%<br>`;
            html += `<strong>Alertas analizadas:</strong> ${analisis.totalHits}`;
            html += '</div>';

            if (analisis.sugerencias.length) {
                html += '<h4 style="color:#00ff41;margin:8px 0 4px;">Recomendaciones inteligentes:</h4>';
                analisis.sugerencias.forEach(sug => {
                    html += `<div class="alert alert-warning">${sug}</div>`;
                });
            }

            container.innerHTML = html;
        }

        function resetearFormulario() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('results-eval').innerHTML = '<h3>Resultados de evaluaci√≥n</h3><p style="color:#58ffc7;">Selecciona componentes y pulsa ‚ÄúEvaluar compatibilidad‚Äù.</p>';
            document.getElementById('results-ia').innerHTML = '<h3>ü§ñ An√°lisis IA</h3><p style="color:#58ffc7;">Pulsa ‚ÄúEvaluar con IA‚Äù para generar el diagn√≥stico inteligente.</p>';

        }

        function enfocarResultados(elementId) {
            const el = document.getElementById(elementId);
            if (el) el.scrollTop = 0;
        }
    </script>
</body>
</html>