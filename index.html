<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluador Packaging + IA</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #05060f;
            color: #e5f2ff;
            min-height: 100vh;
        }
        html { scroll-behavior: smooth; }
        .header {
            background: #0d1220;
            padding: 16px 12px;
            border-bottom: 2px solid #00ff41;
            text-align: center;
        }
        .header h1 { font-size: 1.2rem; color: #00ff41; }
        .header p { font-size: 0.85rem; color: #58ffc7; margin-top: 4px; }
        .container { padding: 14px; max-width: 1200px; margin: 0 auto; }
        .section {
            background: #0d1220;
            border: 1px solid #131a2e;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .section-title {
            color: #00ff41;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 220px;
            overflow-y: auto;
            padding-right: 4px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            background: #131a2e;
            border-radius: 4px;
        }
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #00ff41;
        }
        .checkbox-item label { flex: 1; font-size: 0.9rem; }
        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            margin: 16px 0;
        }
        .btn {
            padding: 14px;
            border-radius: 8px;
            border: 2px solid #00ff41;
            background: #131a2e;
            color: #e5f2ff;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s all;
        }
        .btn:hover { background: #00ff41; color: #05060f; }
        .btn-ia { border-color: #58ffc7; }
        .btn-reset { border-color: #ffcc70; }
        .results {
            background: #0d1220;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 14px;
            max-height: 520px;
            overflow-y: auto;
        }
        .results h3 { color: #00ff41; margin-bottom: 6px; }
        .alert {
            padding: 8px 10px;
            margin: 6px 0;
            border-radius: 4px;
            border-left: 4px solid;
            font-size: 0.9rem;
            white-space: pre-line;
        }
        .alert-error { background: rgba(255,107,107,0.1); border-color: #ff6b6b; color: #ff8686; }
        .alert-warning { background: rgba(255,204,112,0.1); border-color: #ffcc70; color: #ffd083; }
        .alert-info { background: rgba(88,255,199,0.1); border-color: #58ffc7; color: #a3ffe3; }
        .sequence {
            margin-top: 8px;
            padding: 10px;
            background: #131a2e;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .sequence-item { padding: 3px 0; }
        @media (max-width: 768px) {
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Packaging + Lux Assistant (Web)</h1>
        <p>Solo Evaluaci√≥n ‚Äì Botones: Evaluar | Evaluar con IA | Reset</p>
    </header>

    <main class="container">
        <div class="section">
            <div class="section-title">Material(es)</div>
            <div class="checkbox-group" id="materials-eval"></div>
        </div>
        <div class="section">
            <div class="section-title">Tinta(s)</div>
            <div class="checkbox-group" id="inks-eval"></div>
        </div>
        <div class="section">
            <div class="section-title">Barniz(es) / Laca(s)</div>
            <div class="checkbox-group" id="varnishes-eval"></div>
        </div>
        <div class="section">
            <div class="section-title">Laminado(s) / Film(s)</div>
            <div class="checkbox-group" id="films-eval"></div>
        </div>
        <div class="section">
            <div class="section-title">Acabados</div>
            <div class="checkbox-group" id="finishes-eval"></div>
        </div>
        <div class="section">
            <div class="section-title">Pegado / Adhesivo</div>
            <div class="checkbox-group" id="adhesion-eval"></div>
        </div>
        <div class="section">
            <div class="section-title">Proceso / Contexto</div>
            <div class="checkbox-group" id="process-flags-eval"></div>
        </div>

        <div class="actions">
            <button class="btn" onclick="evaluarCompatibilidad()">üß™ Evaluar compatibilidad</button>
            <button class="btn btn-ia" onclick="evaluarConIA()">ü§ñ Evaluar con IA</button>
            <button class="btn btn-reset" onclick="resetearFormulario()">üîÑ Refrescar / Reset</button>
        </div>

        <section class="results" id="results-eval">
            <h3>Resultados de evaluaci√≥n</h3>
            <p style="color:#58ffc7;">Selecciona componentes y pulsa ‚ÄúEvaluar compatibilidad‚Äù.</p>
        </section>

        <section class="results" id="results-ia">
            <h3>ü§ñ An√°lisis IA</h3>
            <p style="color:#58ffc7;">Pulsa ‚ÄúEvaluar con IA‚Äù para generar el diagn√≥stico inteligente.</p>
        </section>
    </main>

    <script>
        const CONFIG = {
  "catalog": {
    "materials": [
      "FBB (GC1/GC2) ‚Äì cart√≥n estucado fibra virgen",
      "SBS/SBB (GZ) ‚Äì cart√≥n blanqueado premium",
      "SUS ‚Äì kraft virgen dorso marr√≥n",
      "WLC (GD/GT) ‚Äì reciclado estucado dorso gris/crema",
      "Cast Coated ‚Äì alto brillo espejo",
      "Cart√≥n con barrera acuosa/dispersion (sin film)",
      "Cart√≥n con PE/biopol√≠mero (barrera extruida)",
      "Cart√≥n metalizado (foil/transfer metal)"
    ],
    "inks": [
      "Offset Convencional (est√°ndar)",
      "Offset Convencional ‚Äì Baja Migraci√≥n (LM)",
      "UV Offset",
      "UV-LED Offset / Low Energy UV",
      "Serigraf√≠a UV",
      "Flexo UV (barniz/integrado)"
    ],
    "varnishes": [
      "Acuoso (AQ) brillo",
      "Acuoso (AQ) mate",
      "UV brillo",
      "UV mate/satinado",
      "Soft touch acuoso",
      "Soft touch film (laminado)",
      "Drip-off (offset+UV)",
      "Anti-scratch/anti-scuff OPV",
      "Barniz serigr√°fico alto relieve",
      "Texturizado (arena, rugoso)",
      "Arom√°tico (scratch & sniff)",
      "Baja migraci√≥n (LM) UV/OPV"
    ],
    "films": [
      "Laminado BOPP brillo",
      "Laminado BOPP mate",
      "Laminado PET brillo",
      "Laminado Soft-touch (velvet)",
      "Laminado Hologr√°fico"
    ],
    "finishes": [
      "Hot foil (estamping caliente)",
      "Cold foil (en fr√≠o)",
      "Cast & Cure (holograf√≠a clara)",
      "Emboss (relieve)",
      "Deboss (bajo relieve)",
      "Relieve multinivel",
      "Serigraf√≠a UV alto dep√≥sito (relieve)",
      "Glitter (serigraf√≠a/UV)",
      "Braille (farma)",
      "Troquel l√°ser / microperforado",
      "Marcado l√°ser (trazabilidad)",
      "C√≥digos invisibles UV/IR"
    ],
    "adhesion_glue": [
      "Pegado PVA (cola blanca)",
      "Hotmelt EVA/PO",
      "Cianoacrilato / especial"
    ],
    "process_flags": [
      "Hendido/plegado",
      "Plegado/encolado",
      "Alimentaci√≥n",
      "Reciclabilidad",
      "Farma"
    ]
  },
  "rules": [
    {
      "when_all": {
        "finishes": [
          "Hot foil (estamping caliente)"
        ],
        "varnishes": [
          "UV brillo",
          "UV mate/satinado"
        ]
      },
      "severity": "WARNING",
      "message": "Barniz UV sobre hot foil puede producir de-wetting y p√©rdida de brillo. Usar OPV compatible o reservar."
    },
    {
      "when_all": {
        "varnishes": [
          "Anti-scratch/anti-scuff OPV"
        ]
      },
      "severity": "INFO",
      "message": "Soft touch es sensible al rayado: considera OPV anti-scuff compatible o laminar con soft-touch."
    },
    {
      "when_all": {
        "finishes": [
          "C√≥digos invisibles UV/IR"
        ],
        "films": [
          "Laminado BOPP brillo",
          "Laminado BOPP mate",
          "Laminado PET brillo"
        ]
      },
      "severity": "WARNING",
      "message": "El laminado puede inutilizar la lectura de c√≥digos UV/IR. Deja ventana sin laminar o imprime por segunda pasada."
    },
    {
      "when_all": {
        "materials": [
          "Cart√≥n metalizado (foil/transfer metal)"
        ],
        "inks": [
          "Offset Convencional (est√°ndar)"
        ]
      },
      "severity": "WARNING",
      "message": "Sobre metalizado, la densidad y el trapping cambian: usar cama blanca/primer y ajustar curvas."
    },
    {
      "when_all": {
        "material": [
          "WLC (GD/GT) ‚Äì reciclado estucado dorso gris/crema"
        ],
        "finishes": [
          "Hot foil (estamping caliente)"
        ]
      },
      "severity": "WARNING",
      "message": "Hot foil sobre WLC puede fallar por baja resistencia superficial/estucado heterog√©neo. Recomiende foil adhesivo 'agresivo', presi√≥n mayor y prueba previa."
    },
    {
      "when_all": {
        "material": [
          "SUS ‚Äì kraft virgen dorso marr√≥n"
        ],
        "finishes": [
          "Cold foil (en fr√≠o)"
        ]
      },
      "severity": "ERROR",
      "message": "Cold foil requiere superficie muy lisa y pre-adhesivo UV; dorso kraft no estucado no es adecuado. Usar cara estucada o pre-coat."
    },
    {
      "when_all": {
        "material": [
          "Cast Coated ‚Äì alto brillo espejo"
        ],
        "finishes": [
          "Emboss (relieve)",
          "Relieve multinivel"
        ]
      },
      "severity": "WARNING",
      "message": "Cast coated es r√≠gido y quebradizo en relieve profundo; riesgo de craquelado/brillo roto. Reducir profundidad, usar utillaje templado y prueba."
    },
    {
      "when_all": {
        "finishes": [
          "Cast & Cure (holograf√≠a clara)"
        ],
        "varnishes": [
          "UV brillo",
          "UV mate/satinado"
        ]
      },
      "severity": "INFO",
      "message": "Cast & Cure requiere barniz UV curable y superficie lisa. Verificar dureza UV y pel√≠cula para evitar bloqueo."
    },
    {
      "when_all": {
        "varnishes": [
          "Soft touch acuoso",
          "Soft touch film (laminado)"
        ],
        "finishes": [
          "Hot foil (estamping caliente)"
        ]
      },
      "severity": "WARNING",
      "message": "Soft touch tiene baja energ√≠a superficial: usar foil/placa espec√≠ficos para soft touch o aplicar primer. Riesgo de mala transferencia."
    },
    {
      "when_all": {
        "inks": [
          "Offset Convencional (est√°ndar)"
        ],
        "context": [
          "Alimentaci√≥n"
        ]
      },
      "severity": "ERROR",
      "message": "Evitar tintas convencionales est√°ndar en estuches alimentarios sensibles. Use series LM o barrera funcional validada."
    }
  ]
};
        const USER_RULES = [];
        const USER_MATERIALS = [];

        function crearCheckboxes(id, items) {
            const cont = document.getElementById(id);
            cont.innerHTML = '';
            (items || []).forEach(nombre => {
                const wrapper = document.createElement('div');
                wrapper.className = 'checkbox-item';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.value = nombre;

                const label = document.createElement('label');
                label.textContent = nombre;

                wrapper.appendChild(input);
                wrapper.appendChild(label);
                cont.appendChild(wrapper);
            });
        }

        function inicializar() {
            const catalog = CONFIG.catalog || {};
            if (USER_MATERIALS && Array.isArray(USER_MATERIALS)) {
                catalog.materials = catalog.materials || [];
                USER_MATERIALS.forEach(m => {
                    if (m.nombre && !catalog.materials.includes(m.nombre)) {
                        catalog.materials.push(m.nombre);
                    }
                });
            }

            crearCheckboxes('materials-eval', catalog.materials || []);
            crearCheckboxes('inks-eval', catalog.inks || []);
            crearCheckboxes('varnishes-eval', catalog.varnishes || []);
            crearCheckboxes('films-eval', catalog.films || []);
            crearCheckboxes('finishes-eval', catalog.finishes || []);
            crearCheckboxes('adhesion-eval', catalog.adhesion_glue || []);
            crearCheckboxes('process-flags-eval', catalog.process_flags || []);
        }

        window.onload = inicializar;

        function obtenerSeleccionEval() {
            const seleccion = {};
            const keys = ['materials', 'inks', 'varnishes', 'films', 'finishes', 'adhesion_glue'];
            keys.forEach(key => {
                seleccion[key] = [];
                document.querySelectorAll(`#${key}-eval input[type="checkbox"]:checked`).forEach(cb => {
                    seleccion[key].push(cb.value);
                });
            });

            seleccion.process = [];
            seleccion.context = [];
            document.querySelectorAll('#process-flags-eval input[type="checkbox"]:checked').forEach(cb => {
                const v = cb.value;
                if (v === 'Hendido/Plegado' || v === 'Plegado/encolado' || v === 'Hendido/plegado') {
                    seleccion.process.push(v);
                } else {
                    seleccion.context.push(v);
                }
            });

            return seleccion;
        }

        function ejecutarEvaluacion(seleccion) {
            const hits = [];
            (CONFIG.rules || []).forEach(regla => {
                let cumple = true;
                const condiciones = regla.when_all || {};
                for (const [key, valores] of Object.entries(condiciones)) {
                    const k = key === 'material' ? 'materials' : key;
                    if (k === 'context') {
                        if (!valores.every(v => seleccion.context.includes(v))) {
                            cumple = false;
                            break;
                        }
                    } else {
                        if (!seleccion[k] || !valores.every(v => seleccion[k].includes(v))) {
                            cumple = false;
                            break;
                        }
                    }
                }
                if (cumple) {
                    hits.push({ severity: regla.severity, message: regla.message });
                }
            });

            const subs = seleccion.materials || [];
            const inks = seleccion.inks || [];
            const fins = seleccion.finishes || [];

            (USER_RULES || []).forEach(kr => {
                let triggers = true;
                if (kr.kw_materials?.length) {
                    triggers = triggers && kr.kw_materials.some(kw =>
                        subs.some(s => s.toLowerCase().includes(kw.toLowerCase()))
                    );
                }
                if (kr.kw_inks?.length) {
                    triggers = triggers && kr.kw_inks.some(kw =>
                        inks.some(i => i.toLowerCase().includes(kw.toLowerCase()))
                    );
                }
                if (kr.kw_finishes?.length) {
                    triggers = triggers && kr.kw_finishes.some(kw =>
                        fins.some(f => f.toLowerCase().includes(kw.toLowerCase()))
                    );
                }
                if (triggers) {
                    let msg = `[${kr.severity}] ${kr.name || 'Regla'}: ${kr.message}`;
                    if (kr.remedy) msg += `\n‚Üí ${kr.remedy}`;
                    hits.push({ severity: kr.severity, message: msg });
                }
            });

            const secuencia = generarSecuencia(seleccion);
            const procAlerts = analizarSecuencia(secuencia, subs, inks, fins);
            return { hits, secuencia, procAlerts };
        }

        function evaluarCompatibilidad() {
            const seleccion = obtenerSeleccionEval();
            const resultado = ejecutarEvaluacion(seleccion);
            mostrarResultadosCompatibilidad(seleccion, resultado);
            enfocarResultados('results-eval');
        }

        function evaluarConIA() {
            const seleccion = obtenerSeleccionEval();
            const resultado = ejecutarEvaluacion(seleccion);
            const analisis = generarAnalisisIA(resultado);
            mostrarResultadosIA(analisis);
            enfocarResultados('results-ia');
        }

        function generarSecuencia(seleccion) {
            const seq = [];
            const materials = seleccion.materials || [];
            const inks = seleccion.inks || [];
            const finishes = seleccion.finishes || [];
            const filmsSel = seleccion.films || [];
            const varnishes = seleccion.varnishes || [];

            seq.push("Preimpresi√≥n: perfiles, trapping, reservas (foil/UV/cola).");
            if (materials.some(m => m.toLowerCase().includes("metalizado"))) {
                seq.push("Serigraf√≠a: cama blanca opaca para metalizado si requiere.");
            }
            if (inks.some(i => i.includes("Offset"))) {
                seq.push("Impresi√≥n offset (CMYK/Pantone).");
            }
            if (finishes.some(f => f.includes("Cold foil"))) {
                seq.push("Cold foil en l√≠nea/sobreimprimible (si aplica).");
            }
            if (finishes.some(f => f.toLowerCase().includes("hot foil") || f.toLowerCase().includes("estamping"))) {
                seq.push("Hot foil (tras impresi√≥n; antes de relieve).");
            }
            if (filmsSel.length > 0) {
                seq.push("Laminaci√≥n (brillo/mate/soft-touch) seg√∫n dise√±o.");
            }
            if (varnishes.length > 0) {
                seq.push("Barnices (UV/AQ/anti-scuff) con reservas de cola.");
            }
            if (finishes.some(f => f.toLowerCase().includes("braille"))) {
                seq.push("Braille despu√©s de laminaci√≥n para mantener altura.");
            }
            seq.push("Troquelado + Hendidos.");
            seq.push("Plegado + Pegado.");
            seq.push("Control de calidad final.");
            return seq;
        }

        function analizarSecuencia(sequence, materials, inks, finishes) {
            const alerts = [];
            const seqLower = sequence.map(s => s.toLowerCase());

            if (seqLower.some(s => s.includes("hot foil")) && seqLower.some(s => s.includes("barniz"))) {
                alerts.push({
                    severity: "WARNING",
                    message: "Barniz posterior puede apagar el brillo del foil. Usar OPV para foil o reserva."
                });
            }
            if (finishes.some(f => f.toLowerCase().includes("soft touch")) &&
                finishes.some(f => f.toLowerCase().includes("hot foil"))) {
                alerts.push({
                    severity: "WARNING",
                    message: "Soft-touch con hot foil: baja energ√≠a superficial, usar primer o foil espec√≠fico."
                });
            }
            if (materials.some(m => m.toLowerCase().includes("cast coated")) &&
                finishes.some(f => f.toLowerCase().includes("relieve"))) {
                alerts.push({
                    severity: "WARNING",
                    message: "Cast Coated en relieve profundo: riesgo de craquelado, reducir profundidad y usar utillaje templado."
                });
            }

            return alerts;
        }

        function mostrarResultadosCompatibilidad(seleccion, resultado) {
            const container = document.getElementById('results-eval');
            let html = '<h3>Resultados de evaluaci√≥n</h3>';

            html += '<div style="margin:6px 0;padding:8px;background:#131a2e;border-radius:4px;"><strong>Selecci√≥n actual:</strong><br>';
            for (const [k, vals] of Object.entries(seleccion)) {
                if (vals?.length) {
                    html += `<strong>${k}:</strong> ${vals.join(', ')}<br>`;
                }
            }
            html += '</div>';

            const allHits = [...resultado.hits, ...resultado.procAlerts];
            if (allHits.length) {
                html += '<h4 style="color:#00ff41;margin:8px 0 4px;">Alertas detectadas:</h4>';
                const order = { ERROR: 0, WARNING: 1, INFO: 2 };
                allHits.sort((a, b) => (order[a.severity] ?? 3) - (order[b.severity] ?? 3));
                allHits.forEach(hit => {
                    const cls = hit.severity === 'ERROR' ? 'alert-error'
                              : hit.severity === 'WARNING' ? 'alert-warning'
                              : 'alert-info';
                    html += `<div class="alert ${cls}">${hit.message}</div>`;
                });
            } else {
                html += '<div class="alert alert-info">‚úì Sin alertas con las reglas actuales.</div>';
            }

            html += '<h4 style="color:#00ff41;margin:8px 0 4px;">Secuencia recomendada:</h4>';
            html += '<div class="sequence">';
            resultado.secuencia.forEach((paso, idx) => {
                html += `<div class="sequence-item">${idx + 1}. ${paso}</div>`;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        function generarAnalisisIA(resultado) {
            const totalHits = [...resultado.hits, ...resultado.procAlerts];
            const errores = totalHits.filter(h => h.severity === 'ERROR').length;
            const warnings = totalHits.filter(h => h.severity === 'WARNING').length;
            const esCompatible = errores === 0;
            let nivel = 'BAJO';
            if (errores > 0) nivel = 'CR√çTICO';
            else if (warnings > 0) nivel = 'ALTO';

            const confianza = Math.max(0, Math.min(1, 1 - errores * 0.3 - warnings * 0.1));
            const sugerencias = [];
            if (warnings > 0) sugerencias.push("‚ö†Ô∏è Revisa las advertencias antes de liberar producci√≥n.");
            if (!esCompatible) sugerencias.push("‚ùå Ajusta componentes antes de continuar.");
            if (totalHits.length === 0) sugerencias.push("‚úÖ Sin conflictos detectados, procede con confianza.");

            return {
                esCompatible,
                nivel,
                confianza,
                totalHits: totalHits.length,
                sugerencias
            };
        }

        function mostrarResultadosIA(analisis) {
            const container = document.getElementById('results-ia');
            let html = '<h3>ü§ñ An√°lisis IA</h3>';

            html += `<div class="alert ${analisis.esCompatible ? 'alert-info' : 'alert-error'}" style="border-left-width:5px;">`;
            html += `<strong>Estado:</strong> ${analisis.esCompatible ? '‚úÖ COMPATIBLE' : '‚ùå INCOMPATIBLE'}<br>`;
            html += `<strong>Riesgo:</strong> ${analisis.nivel}<br>`;
            html += `<strong>Confianza:</strong> ${(analisis.confianza * 100).toFixed(0)}%<br>`;
            html += `<strong>Alertas analizadas:</strong> ${analisis.totalHits}`;
            html += '</div>';

            if (analisis.sugerencias.length) {
                html += '<h4 style="color:#00ff41;margin:8px 0 4px;">Recomendaciones inteligentes:</h4>';
                analisis.sugerencias.forEach(sug => {
                    html += `<div class="alert alert-warning">${sug}</div>`;
                });
            }

            container.innerHTML = html;
        }

        function resetearFormulario() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('results-eval').innerHTML = '<h3>Resultados de evaluaci√≥n</h3><p style="color:#58ffc7;">Selecciona componentes y pulsa ‚ÄúEvaluar compatibilidad‚Äù.</p>';
            document.getElementById('results-ia').innerHTML = '<h3>ü§ñ An√°lisis IA</h3><p style="color:#58ffc7;">Pulsa ‚ÄúEvaluar con IA‚Äù para generar el diagn√≥stico inteligente.</p>';

        }

        function enfocarResultados(elementId) {
            const el = document.getElementById(elementId);
            if (el) el.scrollTop = 0;
        }
    </script>
</body>
</html>